!function(t){function e(a){if(r[a])return r[a].exports;var o=r[a]={i:a,l:!1,exports:{}};return t[a].call(o.exports,o,o.exports,e),o.l=!0,o.exports}var r={};e.m=t,e.c=r,e.d=function(t,r,a){e.o(t,r)||Object.defineProperty(t,r,{configurable:!1,enumerable:!0,get:a})},e.n=function(t){var r=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(r,"a",r),r},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="/dist/",e(e.s=0)}([function(t,e,r){"use strict";function a(t){n("log",t)}function o(t){return n("progress",t)}function n(t,e){self.postMessage({type:t,data:e})}function s(t,e,r,n){var s={progressCallback:o};n.debug&&(s.logCallback=a);var l=new i.a(cv,s),h=l.process(t,e,r,n);self.postMessage({type:"result",data:h})}Object.defineProperty(e,"__esModule",{value:!0});var i=r(1);self.importScripts("./opencv.js"),self.postMessage({type:"state",data:"ready"}),self.addEventListener("message",function(t){self.postMessage({type:"progress",data:{message:"started",progress:10}}),s(t.data.imageData,t.data.width,t.data.height,t.data.options)}),e.default=self},function(t,e,r){"use strict";function a(t){if(Array.isArray(t)){for(var e=0,r=Array(t.length);e<t.length;e++)r[e]=t[e];return r}return Array.from(t)}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t){for(var e=0,r=1/0,a=-1/0,o=1/0,n=void 0,s=void 0,i=void 0,l=void 0,h=0;h<t.length;h+=1){var u=t[h],c=u[0]+u[1],d=u[0]-u[1];c>e&&(e=c,n=h),c<r&&(r=c,s=h),d>a&&(a=d,i=h),d<o&&(o=d,l=h)}return[t[s],t[i],t[n],t[l]]}function s(t){var e,r=(e=[]).concat.apply(e,a(t));return r.some(Array.isArray)?s(r):r}function i(t,e,r){var a=n(r),o=h(a,4),i=o[0],l=o[1],u=o[2],c=o[3],d=Math.sqrt(Math.pow(u[0]-c[0],2)+Math.pow(u[1]-c[1],2)),g=Math.sqrt(Math.pow(l[0]-i[0],2)+Math.pow(l[1]-i[1],2)),v=Math.max(Math.floor(d),Math.floor(g)),f=Math.sqrt(Math.pow(l[0]-u[0],2)+Math.pow(l[1]-u[1],2)),p=Math.sqrt(Math.pow(i[0]-c[0],2)+Math.pow(i[1]-c[1],2)),w=Math.max(Math.floor(f),Math.floor(p)),M=[[0,0],[v-1,0],[v-1,w-1],[0,w-1]],y=t.matFromArray(4,1,t.CV_32FC2,s(a)),m=t.matFromArray(4,1,t.CV_32FC2,s(M)),C=t.getPerspectiveTransform(y,m),b=new t.Size(e.cols,e.rows),A=new t.Mat;return t.warpPerspective(e,A,C,b,t.INTER_LINEAR,t.BORDER_CONSTANT,new t.Scalar),y.delete(),m.delete(),C.delete(),{warped:A,width:v,height:w}}function l(t,e,r){var a=null,o=e.cols,n=e.rows;if(void 0===r.width&&void 0===r.height)return e;if(void 0===r.width){var s=r.height/n;a=[Math.floor(o*s),r.height]}else{var i=r.width/o;a=[r.width,Math.floor(n*i)]}var l=new t.Size(a[0],a[1]),h=new t.Mat;return t.resize(e,h,l,0,0,t.INTER_AREA),h}var h=function(){function t(t,e){var r=[],a=!0,o=!1,n=void 0;try{for(var s,i=t[Symbol.iterator]();!(a=(s=i.next()).done)&&(r.push(s.value),!e||r.length!==e);a=!0);}catch(t){o=!0,n=t}finally{try{!a&&i.return&&i.return()}finally{if(o)throw n}}return r}return function(e,r){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e))return t(e,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),u=function(){function t(t,e){for(var r=0;r<e.length;r++){var a=e[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(e,r,a){return r&&t(e.prototype,r),a&&t(e,a),e}}(),c=[255,0,0,0],d={A4:[210,297]},g=function(){function t(e,r){o(this,t),this.cv=e,this.options=r,this.debug=!!this.options.logCallback}return u(t,[{key:"logProgress",value:function(t,e,r){if(this.logCount+=1,this.options.progressCallback&&this.options.progressCallback({progress:Math.floor(this.logCount/10*100),message:e,points:r}),this.options.logCallback&&t){var a=this.toImageData(t);this.options.logCallback({progress:Math.floor(this.logCount/10*100),message:e,width:t.cols,height:t.rows,imageData:a})}}},{key:"toImageData",value:function(t){var e=this.cv,r=new e.Mat,a=t.type()%8,o=a<=e.CV_8S?1:a<=e.CV_32S?1/256:255,n=a===e.CV_8S||a===e.CV_16S?128:0;switch(t.convertTo(r,e.CV_8U,o,n),r.type()){case e.CV_8UC1:e.cvtColor(r,r,e.COLOR_GRAY2RGBA);break;case e.CV_8UC3:e.cvtColor(r,r,e.COLOR_RGB2RGBA);break;case e.CV_8UC4:break;default:throw new Error("Bad number of channels (Source image must have 1, 3 or 4 channels)")}return new ImageData(new Uint8ClampedArray(r.data),r.cols,r.rows)}},{key:"resize",value:function(t,e){return l(this.cv,t,e)}},{key:"prepareImage",value:function(t){var e=this.cv,r=new this.cv.Mat,a=new this.cv.Mat,o=new this.cv.Mat,n={gaussianBlurSize:5,cannyThreshold1:145,cannyThreshold2:310,cannyApertureSize:5,cannyL2Gradient:!1};return e.cvtColor(t,r,e.COLOR_RGBA2GRAY),this.logProgress(r,"Gray"),e.GaussianBlur(r,a,{width:n.gaussianBlurSize,height:n.gaussianBlurSize},0,0,e.BORDER_DEFAULT),this.logProgress(a,"Blurred"),e.Canny(a,o,n.cannyThreshold1,n.cannyThreshold2,n.cannyApertureSize,n.cannyL2Gradient),this.logProgress(o,"Edge detection"),r.delete(),o}},{key:"getPoints",value:function(t,e){function r(t,e){return t.val<e.val?1:t.val>e.val?-1:0}var a=this.cv,o={contoursMode:a.RETR_TREE,contoursMethod:a.CHAIN_APPROX_SIMPLE},n=new a.MatVector,s=new a.Mat;a.findContours(t,n,s,Number(o.contoursMode),Number(o.contoursMethod),{x:0,y:0});var i=[],l=void 0;this.debug&&(l=a.Mat.zeros(t.rows,t.cols,a.CV_8UC3));for(var h=0;h<n.size();++h){this.debug&&a.drawContours(l,n,h,c,1,a.LINE_8,s);var u=a.contourArea(n.get(h));i.push({val:u,index:h}),i.sort(r),i=i.slice(0,3)}this.debug&&(this.logProgress(l,"all contours"),l.delete());var d=void 0;this.debug&&(d=a.Mat.zeros(t.rows,t.cols,a.CV_8UC3));var g=void 0,v=null,f=!0,p=!1,w=void 0;try{for(var M,y=i[Symbol.iterator]();!(f=(M=y.next()).done);f=!0){var m=M.value,C=n.get(m.index);this.debug&&a.drawContours(d,n,m.index,c,1,a.LINE_8,s);var b=new a.Mat,A=a.arcLength(C,!0);if(a.approxPolyDP(C,b,.02*A,!0),console.log(m.index,b.rows),C.delete(),4===b.rows){g=b,v=m.index;break}}}catch(t){p=!0,w=t}finally{try{!f&&y.return&&y.return()}finally{if(p)throw w}}if(this.debug&&(this.logProgress(d,"top contours"),d.delete()),n.delete(),s.delete(),null===v){var _=new a.Mat,P=Math.floor(.5*(t.rows?e:t.cols));a.HoughLinesP(t,_,1,Math.PI/360,60,P,30);for(var R=0,S=0,E=1/0,k=1/0,x=1/0,O=1/0,z=0,B=0,I=0;I<_.rows;++I){var T=[_.data32S[4*I],_.data32S[4*I+1]],L=[_.data32S[4*I+2],_.data32S[4*I+3]];if(Math.abs(T[0]-L[0])>Math.abs(T[1]-L[1])){var V=void 0,D=void 0;T[0]<L[0]?(V=T[1],D=L[1]):(V=L[1],D=T[1]),O=Math.min(O,V),x=Math.min(x,D),z=Math.max(z,V),B=Math.max(B,D)}else{var G=void 0,N=void 0;T[1]<L[1]?(G=T[0],N=L[0]):(G=L[0],N=T[0]),R=Math.max(R,G),S=Math.max(S,N),E=Math.min(E,G),k=Math.min(k,N)}}if(this.debug){for(var U=a.Mat.zeros(t.rows,t.cols,a.CV_8UC3),F=0;F<_.rows;++F){var j=new a.Point(_.data32S[4*F],_.data32S[4*F+1]),q=new a.Point(_.data32S[4*F+2],_.data32S[4*F+3]);a.line(U,j,q,[Math.floor(255*Math.random()),255,Math.floor(255*Math.random()),0])}this.logProgress(U,"Fall back lines!"),U.delete()}_.delete();var H=[[E,O],[R,x],[S,B],[k,z]];return t.delete(),H}t.delete(),console.log(g);var W=g.data32S;return[[W[0],W[1]],[W[2],W[3]],[W[4],W[5]],[W[6],W[7]]]}},{key:"crop",value:function(t,e,r){var a=this.cv,o=t.size(),n=new a.Rect(0,0,Math.min(o.width,e),Math.min(o.height,r));console.log(n,t.size(),t.cols,t.rows);var s=a.Mat.zeros(n.width,n.height,a.CV_8UC3);return s=t.roi(n),this.logProgress(s,"Cropped"),s}},{key:"fillEdge",value:function(t,e,r,a,o,n,s,i){i=i||10;for(var l=!0,h=0;l&&h<i;){for(l=!1;e<t.cols&&r<t.rows&&e>=0&&r>=0;){var u=r*t.cols+e;t.data[u]<255&&(l=!0,t.data[u]=255),e+=a,r+=o}e+=n,r+=s,h+=1}}},{key:"makeBlackWhite",value:function(t){var e=this.cv;e.cvtColor(t,t,e.COLOR_RGBA2GRAY,0);var r=new e.Mat;return e.GaussianBlur(t,r,{width:0,height:0},3,0,e.BORDER_DEFAULT),e.addWeighted(t,1.5,r,-.5,0,r,-1),e.threshold(r,r,150,255,e.THRESH_BINARY),this.logProgress(r,"Thresholded"),this.fillEdge(r,r.cols-1,0,0,1,-1,-r.rows),this.fillEdge(r,0,0,1,0,-r.cols,1),this.fillEdge(r,0,r.rows-1,1,0,-r.cols,-1),this.fillEdge(r,0,0,0,1,1,-r.rows),this.logProgress(r,"Edge clean"),r}},{key:"process",value:function(t,e,r,a){var o=this.cv;this.logCount=0;var n=o.matFromImageData(t);t=null;var s=!1;e>r&&(s=!0);var l=void 0,h=void 0;s?(h={width:800},l=n.cols/800):(h={height:800},l=n.rows/800);var u=this.resize(n,h),g=this.prepareImage(u),v=this.getPoints(g,s);if(u.delete(),console.log(v),v=v.map(function(t){return[t[0]*l,t[1]*l]}),console.log(l,v),this.logProgress(null,"points",v),this.debug){for(var f=n.clone(),p=0;p<v.length;p++)o.line(f,new o.Point(v[p][0],v[p][1]),new o.Point(v[(p+1)%4][0],v[(p+1)%4][1]),c,10,o.LINE_AA,0);this.logProgress(f,"annotated"),f.delete()}var w=i(o,n,v),M=w.warped;this.logProgress(M,"Warped");var y=this.crop(M,w.width,w.height);this.logProgress(y,"Cropped"),M.delete(),a.blackwhite&&(y=this.makeBlackWhite(y));var m=d.A4;h=s?{width:Math.floor(1/25.4*150*m[1])}:{width:Math.floor(1/25.4*150*m[0])};var C=this.resize(y,h);y.delete(),t=this.toImageData(C);var b={imageData:t,width:C.cols,height:C.rows};return C.delete(),b}}]),t}();e.a=g}]);
//# sourceMappingURL=photoscan.worker.js.map